apiVersion: v1
kind: ConfigMap
metadata:
  name: containerd-config
  namespace: kube-system
data:
  config.toml: |
    version = 2
    [plugins."io.containerd.grpc.v1.cri".registry]
      [plugins."io.containerd.grpc.v1.cri".registry.configs]
        [plugins."io.containerd.grpc.v1.cri".registry.configs."docker.io"]
          [plugins."io.containerd.grpc.v1.cri".registry.configs."docker.io".tls]
            insecure_skip_verify = true
        [plugins."io.containerd.grpc.v1.cri".registry.configs."ghcr.io"]
          [plugins."io.containerd.grpc.v1.cri".registry.configs."ghcr.io".tls]
            insecure_skip_verify = true
        [plugins."io.containerd.grpc.v1.cri".registry.configs."quay.io"]
          [plugins."io.containerd.grpc.v1.cri".registry.configs."quay.io".tls]
            insecure_skip_verify = true
---
apiVersion: v1
kind: Pod
metadata:
  name: apply-containerd-config
  namespace: kube-system
spec:
  hostNetwork: true
  hostPID: true
  containers:
  - name: apply-config
    image: busybox
    command: 
    - /bin/sh
    - -c
    - |
      # Copy the ConfigMap content to the containerd config.toml
      cp /etc/containerd-config/config.toml /host/etc/containerd/config.toml.new
      
      # Create backup of original config
      cp /host/etc/containerd/config.toml /host/etc/containerd/config.toml.bak || true
      
      # Replace old config with new config
      mv /host/etc/containerd/config.toml.new /host/etc/containerd/config.toml
      
      # Restart containerd
      kill -SIGHUP $(pidof containerd)
      
      # Keep the pod running for a bit to ensure containerd restarts properly
      sleep 30
    securityContext:
      privileged: true
    volumeMounts:
    - name: containerd-config
      mountPath: /etc/containerd-config
    - name: host-etc-containerd
      mountPath: /host/etc/containerd
    - name: host-var-run
      mountPath: /host/var/run
  volumes:
  - name: containerd-config
    configMap:
      name: containerd-config
  - name: host-etc-containerd
    hostPath:
      path: /etc/containerd
  - name: host-var-run
    hostPath:
      path: /var/run
  restartPolicy: Never
