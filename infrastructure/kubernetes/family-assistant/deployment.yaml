# Family Assistant Backend Deployment
# Single Source of Truth - DO NOT create duplicate manifests
# Last Updated: 2025-11-17
# Image: 100.81.76.55:30500/family-assistant:me-fixed (working baseline)
#
# Deployment Strategy:
# - Rolling updates with 1 replica (resource constraints)
# - Pinned to pesubuntu node (image availability)
# - Health checks on port 8001
#
# TODO: Move to multi-node when images properly pushed to registry
# TODO: Enable OTEL when collector is deployed
# TODO: Move secrets to Kubernetes Secret objects

apiVersion: apps/v1
kind: Deployment
metadata:
  name: family-assistant-backend
  namespace: homelab
  labels:
    app: family-assistant-backend
    component: familyai-v3
    version: v2.0.0
spec:
  replicas: 1
  revisionHistoryLimit: 3 # Keep only last 3 ReplicaSets
  selector:
    matchLabels:
      app: family-assistant-backend
      component: familyai-v3
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0
  template:
    metadata:
      labels:
        app: family-assistant-backend
        component: familyai-v3
        version: v2.0.0
      annotations:
        # Force restart annotation (update timestamp to trigger rolling restart)
        kubectl.kubernetes.io/restartedAt: "2025-11-17T23:10:00-03:00"
    spec:
      # Pin to pesubuntu until images are in registry
      nodeSelector:
        kubernetes.io/hostname: pesubuntu

      initContainers:
        - name: init-prompts
          image: 100.81.76.55:30500/family-assistant:v2.1.0-prompts
          imagePullPolicy: Always
          command:
            [
              "/bin/sh",
              "-c",
              "mkdir -p /app/prompts-data && cp -r /app/src/prompts/* /app/prompts-data/",
            ]
          volumeMounts:
            - name: prompts-volume
              mountPath: "/app/prompts-data"

      containers:
        - name: family-assistant
          # IMPORTANT: Always use registry-qualified images
          image: 100.81.76.55:30500/family-assistant:v2.1.0-prompts
          imagePullPolicy: Always

          ports:
            - name: http-api
              containerPort: 8001
              protocol: TCP
            - name: ha-api
              containerPort: 8123
              protocol: TCP
            - name: matrix-api
              containerPort: 8008
              protocol: TCP

          env:
            # Prompt Management
            - name: PROMPTS_DIR
              value: "/app/prompts-data"

            # PostgreSQL Configuration
            - name: POSTGRES_HOST
              value: postgres.homelab.svc.cluster.local
            - name: POSTGRES_PORT
              value: "5432"
            - name: POSTGRES_USER
              value: homelab
            - name: POSTGRES_PASSWORD
              value: homelab123 # TODO: Move to Secret
            - name: POSTGRES_DB
              value: homelab
            - name: DATABASE_URL
              value: postgresql+asyncpg://homelab:homelab123@postgres.homelab.svc.cluster.local:5432/homelab

            # Redis Configuration
            - name: REDIS_HOST
              value: redis.homelab.svc.cluster.local
            - name: REDIS_PORT
              value: "6379"
            - name: REDIS_DB
              value: "0"

            # Vector Database Configuration
            - name: QDRANT_URL
              value: http://qdrant.homelab.svc.cluster.local:6333
            - name: QDRANT_GRPC_URL
              value: http://qdrant.homelab.svc.cluster.local:6334

            # LLM Configuration
            - name: LLAMACPP_BASE_URL
              value: "http://llamacpp-kimi-vl-service.llamacpp.svc.cluster.local:8080"
            - name: OLLAMA_BASE_URL
              value: "http://llamacpp-kimi-vl-service.llamacpp.svc.cluster.local:8080" # Backwards compat

            # Service URLs
            - name: MEM0_API_URL
              value: "http://mem0.homelab.svc.cluster.local:8080"
            - name: N8N_BASE_URL
              value: "http://n8n.homelab.svc.cluster.local:5678"

            # Application Configuration
            - name: SECRET_KEY
              value: ChangeMe!2024#Secure # TODO: Move to Secret
            - name: PYTHONPATH
              value: /app/src

            # Observability - DISABLED until OTEL collector deployed
            - name: OTEL_SDK_DISABLED
              value: "true"
          # - name: OTEL_EXPORTER_OTLP_ENDPOINT
          #   value: http://otel-collector.homelab.svc.cluster.local:4317

          resources:
            requests:
              cpu: 250m
              memory: 512Mi
            limits:
              cpu: "1"
              memory: 2Gi

          livenessProbe:
            httpGet:
              path: /health
              port: 8001
              scheme: HTTP
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 1
            failureThreshold: 3

          readinessProbe:
            httpGet:
              path: /health
              port: 8001
              scheme: HTTP
            initialDelaySeconds: 5
            periodSeconds: 5
            timeoutSeconds: 1
            failureThreshold: 3

          securityContext:
            runAsNonRoot: true
            runAsUser: 1000
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: false
            capabilities:
              drop:
                - ALL

          volumeMounts:
            - name: prompts-volume
              mountPath: "/app/prompts-data"

      volumes:
        - name: prompts-volume
          emptyDir: {}
