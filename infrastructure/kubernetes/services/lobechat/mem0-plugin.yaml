# LobeChat mem0 Memory Plugin Configuration
# This configures LobeChat to use mem0 for persistent memory

# Note: LobeChat doesn't have native mem0 support yet.
# We'll use a custom plugin approach via Tools/Functions

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: lobechat-mem0-plugin
  namespace: homelab
  labels:
    app: lobechat
    component: mem0-plugin
data:
  # mem0 Tool Definition (OpenAI Function Calling format)
  mem0-tool.json: |
    {
      "type": "function",
      "function": {
        "name": "mem0_remember",
        "description": "Store important information about the user in long-term memory. Use this to remember user preferences, facts, and context.",
        "parameters": {
          "type": "object",
          "properties": {
            "memory": {
              "type": "string",
              "description": "The information to remember about the user"
            },
            "category": {
              "type": "string",
              "enum": ["preference", "fact", "context", "relationship"],
              "description": "Category of memory"
            }
          },
          "required": ["memory"]
        }
      }
    }

  mem0-recall-tool.json: |
    {
      "type": "function",
      "function": {
        "name": "mem0_recall",
        "description": "Retrieve relevant memories about the user based on the current conversation context.",
        "parameters": {
          "type": "object",
          "properties": {
            "query": {
              "type": "string",
              "description": "What to search for in user's memory"
            }
          },
          "required": ["query"]
        }
      }
    }

  # System prompt that integrates mem0
  system-prompt-with-memory.txt: |
    You are a helpful AI assistant with long-term memory capabilities.

    IMPORTANT: You have access to persistent memory about the user through the mem0_remember and mem0_recall functions.

    - Use mem0_remember() to store important facts, preferences, and context about the user
    - Use mem0_recall() at the start of conversations to retrieve relevant memories
    - Reference memories naturally in conversation to show continuity

    Examples of what to remember:
    - User's name, location, occupation
    - Interests, hobbies, preferences
    - Past conversations and context
    - Ongoing projects or goals
    - Relationships and personal details

    Always aim to provide personalized responses based on what you remember about the user.

---
# ConfigMap with helper scripts
apiVersion: v1
kind: ConfigMap
metadata:
  name: lobechat-mem0-scripts
  namespace: homelab
  labels:
    app: lobechat
    component: mem0-scripts
data:
  # Helper script for mem0 API calls
  mem0-api.sh: |
    #!/bin/bash
    # mem0 API helper script
    # Usage: ./mem0-api.sh <action> <user_id> [data]

    MEM0_URL="${MEM0_API_URL:-http://mem0.homelab.svc.cluster.local:8080}"
    ACTION="$1"
    USER_ID="$2"
    DATA="$3"

    case "$ACTION" in
      add)
        # Add memory
        curl -X POST "$MEM0_URL/v1/memories/" \
          -H "Content-Type: application/json" \
          -d "{
            \"messages\": [{\"role\": \"user\", \"content\": \"$DATA\"}],
            \"user_id\": \"$USER_ID\"
          }"
        ;;

      search)
        # Search memories
        curl -X POST "$MEM0_URL/v1/memories/search/" \
          -H "Content-Type: application/json" \
          -d "{
            \"query\": \"$DATA\",
            \"user_id\": \"$USER_ID\"
          }"
        ;;

      get)
        # Get all memories for user
        curl -X GET "$MEM0_URL/v1/memories/?user_id=$USER_ID"
        ;;

      *)
        echo "Usage: $0 {add|search|get} <user_id> [data]"
        exit 1
        ;;
    esac

---
# Documentation ConfigMap
apiVersion: v1
kind: ConfigMap
metadata:
  name: lobechat-mem0-docs
  namespace: homelab
data:
  README.md: |
    # LobeChat mem0 Integration

    ## Current Status

    LobeChat doesn't have native mem0 support yet (as of 2025).
    We're using a **middleware approach** until native support is added.

    ## Integration Approaches

    ### Approach 1: Custom Backend Middleware (Recommended)

    Deploy a lightweight Node.js middleware that:
    1. Intercepts LobeChat â†’ Ollama API calls
    2. Calls mem0 API to retrieve relevant memories
    3. Injects memories into system prompt
    4. Forwards to Ollama with enhanced context
    5. Stores important info from response back to mem0

    Location: `services/lobechat-mem0-middleware/`

    ### Approach 2: Client-Side Plugin

    Use LobeChat's plugin system to add mem0 as a custom tool.
    User can manually trigger memory storage/retrieval.

    ### Approach 3: N8n Automation

    Use N8n to:
    1. Monitor LobeChat conversations (via database)
    2. Extract important facts
    3. Store to mem0 asynchronously

    ## mem0 API Endpoints

    - Add memory: `POST /v1/memories/`
    - Search: `POST /v1/memories/search/`
    - Get all: `GET /v1/memories/?user_id={id}`
    - Delete: `DELETE /v1/memories/{memory_id}/`

    ## Next Steps

    1. Choose integration approach
    2. Deploy middleware/plugin
    3. Test with Spanish conversations
    4. Monitor memory persistence
