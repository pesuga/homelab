# Flux CD Repository Structure Analysis & Recommendations

## Current Repository Structure

```
homelab/
├── infrastructure/
│   ├── kubernetes/
│   │   ├── base/              # Namespace definitions
│   │   ├── databases/         # PostgreSQL, Redis, Qdrant
│   │   ├── monitoring/        # Prometheus, Grafana, Node Exporter
│   │   ├── services/          # Mem0, etc.
│   │   ├── flowise/           # Flowise deployment
│   │   ├── ingress/           # Ingress resources
│   │   ├── certificates/      # Cert-manager, Let's Encrypt
│   │   ├── dns/               # DNS configurations
│   │   └── registry/          # Docker registry
│   ├── compute-node/          # Ollama, LiteLLM configs (not K8s)
│   ├── service-node/          # Node-specific configs
│   └── terraform/             # Future IaC
├── services/
│   ├── llm-router/            # LiteLLM configs
│   ├── homelab-dashboard/     # Dashboard app + K8s manifests
│   ├── mem0/                  # Mem0 app source
│   └── n8n-workflows/         # Workflow exports
├── docs/                      # Documentation
└── scripts/                   # Utility scripts
```

## Flux CD Recommended Structure

Flux CD follows a **monorepo** pattern with separation between infrastructure and application layers. Here's the industry-standard GitOps structure:

### Recommended Structure

```
homelab/
├── clusters/
│   └── homelab/                    # Cluster-specific configs
│       ├── flux-system/            # Flux bootstrap files (auto-generated)
│       │   ├── gotk-components.yaml
│       │   ├── gotk-sync.yaml
│       │   └── kustomization.yaml
│       ├── infrastructure.yaml     # HelmRepository, source references
│       └── apps.yaml               # Application Kustomization references
│
├── infrastructure/
│   ├── base/                       # Base infrastructure (reusable)
│   │   ├── namespace.yaml
│   │   ├── postgres/
│   │   │   ├── kustomization.yaml
│   │   │   ├── postgres.yaml
│   │   │   └── helm-release.yaml  # If using Helm
│   │   ├── redis/
│   │   ├── qdrant/
│   │   ├── prometheus/
│   │   ├── grafana/
│   │   ├── loki/
│   │   └── cert-manager/
│   │
│   ├── overlays/                   # Environment-specific overlays
│   │   └── homelab/                # Production homelab overlay
│   │       ├── kustomization.yaml  # References base + patches
│   │       ├── postgres-patch.yaml
│   │       └── grafana-patch.yaml
│   │
│   └── sources/                    # Flux sources (HelmRepository, etc.)
│       ├── bitnami.yaml
│       ├── grafana.yaml
│       └── jetstack.yaml
│
├── apps/
│   ├── base/
│   │   ├── n8n/
│   │   │   ├── kustomization.yaml
│   │   │   ├── deployment.yaml
│   │   │   ├── service.yaml
│   │   │   └── ingress.yaml
│   │   ├── flowise/
│   │   ├── mem0/
│   │   ├── homelab-dashboard/
│   │   └── open-webui/
│   │
│   └── overlays/
│       └── homelab/
│           ├── kustomization.yaml
│           ├── n8n-patch.yaml      # Env-specific configs
│           └── secrets.yaml        # Sealed secrets
│
└── services/                       # Application source code (unchanged)
    ├── llm-router/
    ├── homelab-dashboard/
    ├── mem0/
    └── n8n-workflows/
```

## Key Concepts

### 1. Flux System Directory
- **Location**: `clusters/homelab/flux-system/`
- **Purpose**: Auto-generated by `flux bootstrap`
- **Contents**: Flux controllers, sync config
- **Management**: Flux manages this, minimal manual edits

### 2. Infrastructure Layer
- **Base**: Reusable infrastructure components
- **Overlays**: Environment-specific patches (dev, staging, prod)
- **Sources**: External chart repositories, Git sources

### 3. Apps Layer
- **Base**: Application manifests
- **Overlays**: Environment-specific application configs
- **Separation**: Clear boundary between infra and apps

### 4. Kustomize Integration
Flux uses Kustomize for overlays and patches:
```yaml
# infrastructure/overlays/homelab/kustomization.yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
bases:
  - ../../base/postgres
  - ../../base/redis
  - ../../base/prometheus
patches:
  - path: postgres-patch.yaml
    target:
      kind: StatefulSet
      name: postgres
```

## Recommended Reorganization Plan

### Option A: Minimal Disruption (Recommended)
Keep existing structure, add Flux layer on top:

```
homelab/
├── clusters/homelab/               # NEW: Flux entry point
│   ├── flux-system/                # Auto-generated
│   ├── infrastructure.yaml         # Points to infrastructure/kubernetes
│   └── apps.yaml                   # Points to apps manifests
│
├── infrastructure/kubernetes/      # EXISTING: Minimal changes
│   ├── kustomization.yaml          # NEW: Kustomize root
│   ├── base/
│   ├── databases/
│   ├── monitoring/
│   └── services/
│
└── apps/                           # NEW: Extract app-specific manifests
    ├── kustomization.yaml
    ├── n8n/                        # Move from infrastructure/
    ├── flowise/
    ├── mem0/
    └── homelab-dashboard/
```

**Migration**:
1. Create `clusters/homelab/` directory
2. Add Kustomization files to existing directories
3. Move app manifests from `infrastructure/` to `apps/`
4. Bootstrap Flux pointing to `clusters/homelab/`

### Option B: Full Restructure (Industry Standard)
Complete reorganization to match Flux best practices:

**Pros**:
- Clean separation of concerns
- Easier multi-environment support
- Industry-standard structure
- Better scalability

**Cons**:
- More disruptive migration
- Requires updating all paths
- Potential for errors during transition

**Migration**:
1. Create new directory structure
2. Move manifests to appropriate locations
3. Create Kustomization files
4. Update all references
5. Test with `kubectl kustomize`
6. Bootstrap Flux

## Flux GitOps Workflow

### 1. GitRepository Source
```yaml
# clusters/homelab/infrastructure.yaml
apiVersion: source.toolkit.fluxcd.io/v1
kind: GitRepository
metadata:
  name: homelab-infrastructure
  namespace: flux-system
spec:
  interval: 1m
  url: https://github.com/pesuga/homelab
  ref:
    branch: revised-version
  secretRef:
    name: github-auth  # For private repos
```

### 2. Kustomization (Flux)
```yaml
# clusters/homelab/infrastructure.yaml (continued)
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: infrastructure
  namespace: flux-system
spec:
  interval: 10m
  sourceRef:
    kind: GitRepository
    name: homelab-infrastructure
  path: ./infrastructure/kubernetes
  prune: true
  wait: true
  timeout: 5m
```

### 3. Dependency Management
```yaml
# Apps depend on infrastructure
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: apps
  namespace: flux-system
spec:
  dependsOn:
    - name: infrastructure  # Wait for infra first
  interval: 10m
  sourceRef:
    kind: GitRepository
    name: homelab-infrastructure
  path: ./apps
  prune: true
```

## Secret Management

### Sealed Secrets (Recommended)
```bash
# Install Sealed Secrets controller
kubectl apply -f https://github.com/bitnami-labs/sealed-secrets/releases/download/v0.24.0/controller.yaml

# Seal a secret
kubectl create secret generic db-password \
  --from-literal=password=MySecretPassword \
  --dry-run=client -o yaml | \
  kubeseal -o yaml > sealed-secret.yaml

# Commit sealed-secret.yaml to Git (safe)
```

### SOPS (Alternative)
```bash
# Encrypt secrets with SOPS + Age
sops --encrypt --age <AGE_PUBLIC_KEY> secret.yaml > secret.enc.yaml

# Flux decrypts automatically with Age key
```

## Helm Integration

For services with Helm charts (Grafana, Prometheus):

```yaml
# infrastructure/sources/grafana.yaml
apiVersion: source.toolkit.fluxcd.io/v1beta2
kind: HelmRepository
metadata:
  name: grafana
  namespace: flux-system
spec:
  interval: 1h
  url: https://grafana.github.io/helm-charts
---
# infrastructure/base/grafana/helm-release.yaml
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: grafana
  namespace: homelab
spec:
  interval: 5m
  chart:
    spec:
      chart: grafana
      version: 6.60.x
      sourceRef:
        kind: HelmRepository
        name: grafana
        namespace: flux-system
  values:
    adminPassword: ${GRAFANA_ADMIN_PASSWORD}  # From secret
    persistence:
      enabled: true
      size: 5Gi
```

## Multi-Repository Strategy

### Option 1: Monorepo (Current + Recommended)
- **Repository**: Single `homelab` repo
- **Structure**: Everything in one place
- **Pros**: Simple, single source of truth
- **Cons**: Larger repo, all changes trigger syncs

### Option 2: Multi-Repo
- **Infrastructure Repo**: `homelab-infrastructure`
- **Apps Repo**: `homelab-apps`
- **Config Repo**: `homelab-config`
- **Pros**: Granular access control, smaller syncs
- **Cons**: More complexity, multiple repos to manage

**Recommendation**: Stick with monorepo for homelab scale.

## Flux CD Bootstrap Command

### Recommended Bootstrap
```bash
# Export GitHub token
export GITHUB_TOKEN=<your-github-token>

# Bootstrap Flux to homelab cluster
flux bootstrap github \
  --owner=pesuga \
  --repository=homelab \
  --branch=revised-version \
  --path=./clusters/homelab \
  --personal \
  --private=false \
  --network-policy=false
```

### What Bootstrap Does
1. Installs Flux controllers to `flux-system` namespace
2. Creates `clusters/homelab/flux-system/` directory in Git
3. Commits Flux manifests to repository
4. Configures Flux to watch repository
5. Auto-syncs cluster with Git state

## Reconciliation & Health Checks

### Check Flux Status
```bash
# Overall Flux health
flux check

# Kustomization status
flux get kustomizations

# Source status
flux get sources all

# Helm release status
flux get helmreleases -A

# Reconcile manually
flux reconcile kustomization infrastructure --with-source
```

### Auto-Healing
Flux automatically:
- Detects Git changes every 1-10 minutes
- Applies changes to cluster
- Rolls back failed deployments
- Prunes deleted resources
- Validates manifests before applying

## Migration Checklist

### Phase 1: Preparation (15 min)
- [ ] Decide on Option A (minimal) or Option B (full restructure)
- [ ] Create backup of current cluster state
- [ ] Document current deployed resources

### Phase 2: Repository Setup (30 min)
- [ ] Create `clusters/homelab/` directory
- [ ] Add Kustomization files to existing directories
- [ ] Move app manifests to `apps/` if needed
- [ ] Create Flux source and Kustomization manifests
- [ ] Commit and push to GitHub

### Phase 3: Flux Bootstrap (10 min)
- [ ] Generate GitHub token with repo permissions
- [ ] Run `flux bootstrap github` command
- [ ] Verify Flux controllers deployed
- [ ] Check `flux-system` namespace

### Phase 4: Validation (20 min)
- [ ] Verify all resources deployed via Flux
- [ ] Check reconciliation status
- [ ] Test drift detection (manual change)
- [ ] Verify auto-healing (Flux reverts manual changes)

### Phase 5: Integration (15 min)
- [ ] Update documentation (README, CLAUDE.md)
- [ ] Remove manual `kubectl apply` from workflows
- [ ] Set up automated image updates (Flux Image Automation)
- [ ] Configure notifications (Slack, Discord)

## Best Practices

### 1. Directory Naming
- Use lowercase with hyphens: `cert-manager`, `node-exporter`
- Avoid underscores: ✗ `cert_manager`
- Be descriptive: ✓ `grafana-dashboards` ✗ `dashboards`

### 2. Resource Ordering
- Use dependencies in Kustomization:
  ```yaml
  dependsOn:
    - name: infrastructure
  ```
- Order matters: Namespaces → CRDs → Apps

### 3. Health Checks
- Add health checks to Kustomization:
  ```yaml
  healthChecks:
    - apiVersion: apps/v1
      kind: Deployment
      name: n8n
      namespace: homelab
  ```

### 4. Pruning Strategy
- Enable `prune: true` for automatic cleanup
- Use `prune: false` for stateful resources (manual cleanup)

### 5. Notifications
```yaml
apiVersion: notification.toolkit.fluxcd.io/v1beta1
kind: Alert
metadata:
  name: homelab-alerts
  namespace: flux-system
spec:
  providerRef:
    name: slack
  eventSeverity: info
  eventSources:
    - kind: Kustomization
      name: '*'
    - kind: HelmRelease
      name: '*'
```

## Rollback Strategy

### Git-Based Rollback
```bash
# Revert last commit
git revert HEAD
git push

# Flux auto-reverts cluster to previous state
```

### Manual Rollback
```bash
# Suspend reconciliation
flux suspend kustomization apps

# Manually fix cluster
kubectl ...

# Resume reconciliation
flux resume kustomization apps
```

## Next Steps

1. **Decide on Structure**: Choose Option A or B
2. **Create Plan**: Detailed migration steps
3. **Backup Cluster**: Export current state
4. **Implement Changes**: Restructure repository
5. **Bootstrap Flux**: Install Flux to cluster
6. **Validate**: Verify GitOps workflow
7. **Document**: Update all docs
8. **Train**: Practice GitOps workflow

---

**Recommendation**: **Option A** (Minimal Disruption) for homelab use case.

**Estimated Migration Time**: 90 minutes total
**Priority**: P2 (Medium) - Sprint 4 objective
**Dependencies**: Git repository, GitHub token

---

**Created**: 2025-10-30
**Status**: Ready for Review and Implementation
